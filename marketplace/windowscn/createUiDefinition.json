{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Compute.MultiVm",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "clusterName",
        "type": "Microsoft.Common.TextBox",
        "label": "Cluster name",
        "toolTip": "The HPC Pack cluster name, also used as the host name of the head node.",
        "defaultValue": "",
        "constraints": {
          "required": true,
          "regex": "^[a-z][a-z0-9]{2,14}$",
          "validationMessage": "Must contain between 3 and 15 characters with lowercase letters and numbers, and must start with a letter."
        }
      },
      {
        "name": "workLoadType",
        "type": "Microsoft.Common.DropDown",
        "label": "Type of Workloads",
        "defaultValue": "Windows Workloads",
        "toolTip": "Specify the type of workloads you want to run in this HPC cluster. Select \"Excel Workloads\" if you want to run Excel calculations; select \"Windows Workloads\" if you want to run other Windows applications.",
        "constraints": {
          "allowedValues": [
            {
              "label": "Excel Workloads",
              "value": {
                "workload": "Excel",
                "computeNodeImage": {
                  "publisher": "MicrosoftWindowsServerHPCPack",
                  "offer": "WindowsServerHPCPack",
                  "sku": "2012R2CNExcel",
                  "version": "latest"
                }
              }
            },
            {
              "label": "Windows Workloads",
              "value": {
                "workload": "Windows",
                "computeNodeImage": {
                  "publisher": "MicrosoftWindowsServerHPCPack",
                  "offer": "WindowsServerHPCPack",
                  "sku": "2012R2CN",
                  "version": "latest"
                }
              }
            }
          ]
        }
      },
      {
        "name": "excelInfo",
        "type": "Microsoft.Common.InfoBox",
        "visible": "[equals(basics('workLoadType').workload, 'Excel')]",
        "options": {
          "icon": "Info",
          "text": "An evaluation version of Microsoft Excel Professional Plus 2016 is installed on the compute nodes. You shall manually activate it after the deployment."
        }
      }
    ],
    "steps": [
      {
        "name": "headNodeConfig",
        "label": "Head node settings",
        "subLabel": {
          "preValidation": "Configure Head node",
          "postValidation": "Done"
        },
        "bladeTitle": "Head node settings",
        "elements": [
          {
            "name": "vmSize",
            "type": "Microsoft.Compute.SizeSelector",
            "label": "VM Size",
            "toolTip": "VM Size for the head node. If you want to create data disks for the head node, remember the maximum number of data disks (defined by column 'DATA DISKS') supported for the VM size.",
            "recommendedSizes": [
              "Standard_D8s_v3",
              "Standard_DS4_v2",
              "Standard_F8s",
              "Standard_D4s_v3",
              "Standard_DS3_v2",
              "Standard_H16r",
              "Standard_H8",
              "Standard_H16",
              "Standard_DS4"
            ],
            "constraints": {
              "excludedSizes": [
                "Basic_A0",
                "Basic_A1",
                "Basic_A2",
                "Basic_A3",
                "Basic_A4",
                "Standard_A0",
                "Standard_A1",
                "Standard_A2",
                "Standard_A5",
                "Standard_A1_v2",
                "Standard_A2_v2",
                "Standard_A2m_v2",
                "Standard_B1s",
                "Standard_B1ms",
                "Standard_B2s",
                "Standard_B2ms",
                "Standard_D1",
                "Standard_D2",
                "Standard_D11",
                "Standard_D1_v2",
                "Standard_D2_v2",
                "Standard_D11_v2",
                "Standard_DS1",
                "Standard_DS2",
                "Standard_DS11",
                "Standard_DS1_v2",
                "Standard_DS2_v2",
                "Standard_DS11_v2",
                "Standard_F1",
                "Standard_F2",
                "Standard_F1s",
                "Standard_F2s",
                "Standard_G1",
                "Standard_GS1"
              ]
            },
            "osPlatform": "Windows",
            "count": 1
          },
          {
            "name": "osDiskType1",
            "type": "Microsoft.Common.DropDown",
            "label": "OS disk type",
            "defaultValue": "Premium SSD",
            "toolTip": "Premium SSD disks offer high-performance, low-latency disk support for I/O-intensive applications and production workloads. To use Premium SSD disks, you must choose VM Size with premium storage support. Standard SSD Disks are a cost effective storage option optimized for workloads that need consistent performance at lower IOPS levels. Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Standard HDD",
                  "value": "Standard_LRS"
                },
                {
                  "label": "Standard SSD",
                  "value": "StandardSSD_LRS"
                },
                {
                  "label": "Premium SSD",
                  "value": "Premium_LRS"
                }
              ]
            },
            "visible": "[contains(toLower(replace(coalesce(steps('headNodeConfig').vmSize, ''), 'Standard_', '')), 's')]"
          },
          {
            "name": "osDiskType2",
            "type": "Microsoft.Common.DropDown",
            "label": "OS disk type",
            "defaultValue": "Standard SSD",
            "toolTip": "Standard SSD Disks are a cost effective storage option optimized for workloads that need consistent performance at lower IOPS levels. Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Standard HDD",
                  "value": "Standard_LRS"
                },
                {
                  "label": "Standard SSD",
                  "value": "StandardSSD_LRS"
                }
              ]
            },
            "visible": "[not(contains(toLower(replace(coalesce(steps('headNodeConfig').vmSize, ''), 'Standard_', '')), 's'))]"
          },
          {
            "name": "publicIP",
            "type": "Microsoft.Network.PublicIpAddressCombo",
            "label": {
              "publicIpAddress": "Public IP address",
              "domainNameLabel": "DNS name label"
            },
            "toolTip": {
              "publicIpAddress": "The public IP address of the head node. The DNS name label of it must be the same as the cluster name if you want to submit SOA/Excel jobs from an on-premises machine with HPC Pack client utilities installed.",
              "domainNameLabel": "The DNS name label of the public IP address. Must be the same as the cluster name if you want to submit SOA/Excel jobs from an on-premises machine with HPC Pack client utilities installed."
            },
            "defaultValue": {
              "publicIpAddressName": "[concat(basics('clusterName'), 'publicIp')]",
              "domainNameLabel": "[basics('clusterName')]"
            },
            "options": {
              "hideNone": false,
              "hideDomainNameLabel": false
            }
          },
          {
            "name": "createDataDisks",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Create Data Disk(s)",
            "defaultValue": "No",
            "toolTip": "Specify whether you want to create data disk(s) for the head node. Note the data disks will not be initialized, you can initialize them by your own way.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": true
                },
                {
                  "label": "No",
                  "value": false
                }
              ]
            }
          },
          {
            "name": "dataDisks",
            "type": "Microsoft.Common.Section",
            "label": "Data Disk Settings",
            "elements": [
              {
                "name": "diskSize",
                "type": "Microsoft.Common.DropDown",
                "label": "Size of each data disk",
                "defaultValue": "128 GB",
                "toolTip": "The size for each data disk attached to the head node.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "32 GB",
                      "value": 32
                    },
                    {
                      "label": "64 GB",
                      "value": 64
                    },
                    {
                      "label": "128 GB",
                      "value": 128
                    },
                    {
                      "label": "256 GB",
                      "value": 256
                    },
                    {
                      "label": "512 GB",
                      "value": 512
                    },
                    {
                      "label": "1 TB",
                      "value": 1024
                    },
                    {
                      "label": "2 TB",
                      "value": 2048
                    },
                    {
                      "label": "4 TB",
                      "value": 4096
                    }
                  ]
                }
              },
              {
                "name": "diskCount",
                "type": "Microsoft.Common.DropDown",
                "label": "Number of data disks",
                "defaultValue": "1",
                "toolTip": "The number of data disks attached to the head node. Do not specify a number which exceeds the maximum data disk number of the head node VM Size.<br/>You can check the value of column 'DATA DISKS' of your selected head node VM size or refer to <a href='https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes' target='_blank'>Azure VM sizes</a>",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "1",
                      "value": 1
                    },
                    {
                      "label": "2",
                      "value": 2
                    },
                    {
                      "label": "4",
                      "value": 4
                    },
                    {
                      "label": "8",
                      "value": 8
                    },
                    {
                      "label": "16",
                      "value": 16
                    }
                  ]
                }
              },
              {
                "name": "diskType1",
                "type": "Microsoft.Common.DropDown",
                "label": "Data disk type",
                "defaultValue": "Premium SSD",
                "toolTip": "Premium SSD disks offer high-performance, low-latency disk support for I/O-intensive applications and production workloads. To use Premium SSD disks, you must choose VM Size with premium storage support. Standard SSD Disks are a cost effective storage option optimized for workloads that need consistent performance at lower IOPS levels. Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard HDD",
                      "value": "Standard_LRS"
                    },
                    {
                      "label": "Standard SSD",
                      "value": "StandardSSD_LRS"
                    },
                    {
                      "label": "Premium SSD",
                      "value": "Premium_LRS"
                    }
                  ]
                },
                "visible": "[contains(toLower(replace(coalesce(steps('headNodeConfig').vmSize, ''), 'Standard_', '')), 's')]"
              },
              {
                "name": "diskType2",
                "type": "Microsoft.Common.DropDown",
                "label": "Data disk type",
                "defaultValue": "Standard SSD",
                "toolTip": "Standard SSD Disks are a cost effective storage option optimized for workloads that need consistent performance at lower IOPS levels. Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard HDD",
                      "value": "Standard_LRS"
                    },
                    {
                      "label": "Standard SSD",
                      "value": "StandardSSD_LRS"
                    }
                  ]
                },
                "visible": "[not(contains(toLower(replace(coalesce(steps('headNodeConfig').vmSize, ''), 'Standard_', '')), 's'))]"
              }
            ],
            "visible": "[steps('headNodeConfig').createDataDisks]"
          },
          {
            "name": "enableAccelNet",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Accelerated networking",
            "defaultValue": "Off",
            "toolTip": "<a href='https://docs.microsoft.com/en-us/azure/virtual-network/create-vm-accelerated-networking-powershell' target='_blank'>Accelerated networking</a> can greatly improve cluster networking performance with lower latency and higher throughput. It is supported only on some VM sizes and operating systems. Turn it on only when the VM image and VM sizes you selected are all compatible.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "On",
                  "value": true
                },
                {
                  "label": "Off",
                  "value": false
                }
              ]
            },
            "visible": "[contains(';D4s_v3;D8s_v3;D16s_v3;D32s_v3;D64s_v3;D4_v3;D8_v3;D16_v3;D32_v3;D64_v3;D2_v2;D3_v2;D4_v2;D5_v2;D11_v2;D12_v2;D13_v2;D14_v2;D15_v2;DS2_v2;DS3_v2;DS4_v2;DS5_v2;DS11_v2;DS12_v2;DS13_v2;DS14_v2;DS15_v2;F2;F4;F8;F16;F2;F4;F8;F16;F2s;F4s;F8s;F16s;F4s_v2;F8s_v2;F16s_v2;F32s_v2;F64s_v2;F72s_v2;E4_v3;E8_v3;E16_v3;E20_v3;E32_v3;E64_v3;E64i_v3;E4s_v3;E8s_v3;E16s_v3;E20s_v3;E32s_v3;E64s_v3;E64is_v3;M8ms;M16ms;M32ts;M32ls;M32ms;M64s;M64ls;M64ms;M128s;M128ms', replace(coalesce(steps('headNodeConfig').vmSize, 'None'), 'Standard_', ';'))]"
          },
          {
            "name": "runCustomScript",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Run custom script",
            "defaultValue": "No",
            "toolTip": "Specify whether you want to run custom script on the head node after it is configured.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": true
                },
                {
                  "label": "No",
                  "value": false
                }
              ]
            }
          },
          {
            "name": "customScript",
            "type": "Microsoft.Common.Section",
            "label": "Custom Script Settings",
            "elements": [
              {
                "name": "scriptFileUrls",
                "type": "Microsoft.Common.FileUpload",
                "label": "Upload script file(s)",
                "toolTip": "Upload the custom script files to run on the head node, the script files will be stored in a Microsoft provided temporary location and get purged after 24 hours.",
                "constraints": {
                  "required": false,
                  "accept": ".ps1"
                },
                "options": {
                  "multiple": true,
                  "uploadMode": "url",
                  "openMode": "binary"
                },
                "visible": true
              },
              {
                "name": "scriptCommandLine",
                "type": "Microsoft.Common.TextBox",
                "label": "Command line to run",
                "toolTip": "Specify the command line to run the uploaded custom script file with syntax \"&lt;scriptFileName&gt;.ps1 [&lt;Args&gt;]\". The script will be run as Local System account. For example: \"myhnpostscript.ps1 -Arg1 arg1 -Arg2 arg2\". ",
                "defaultValue": "",
                "constraints": {
                  "required": true,
                  "regex": "^\\s*\\S+\\.ps1(\\s+\\S*)*$",
                  "validationMessage": "The syntax is \"&lt;scriptFileName&gt;.ps1 [&lt;Args&gt;]\", for example: \"myhnpostscript.ps1 -Arg1 arg1 -Arg2 arg2\"."
                }
              }
            ],
            "visible": "[steps('headNodeConfig').runCustomScript]"
          }
        ]
      },
      {
        "name": "computeNodeConfig",
        "label": "Compute node settings",
        "subLabel": {
          "preValidation": "Configure compute nodes",
          "postValidation": "Done"
        },
        "bladeTitle": "Compute node settings",
        "elements": [
          {
            "name": "namePrefix",
            "type": "Microsoft.Common.TextBox",
            "label": "Name prefix",
            "toolTip": "The name prefix of the compute nodes. For example, if 'IaaSCN' is specified, the compute node names will be 'IaaSCN000', 'IaaSCN001', ...",
            "defaultValue": "HPCIaaSCN",
            "constraints": {
              "required": true,
              "regex": "^[a-zA-Z][a-zA-Z0-9-]{1,11}$",
              "validationMessage": "Must be no more than 12 characters, begin with a letter, and contain only letters, numbers and hyphens"
            }
          },
          {
            "name": "nodeNumber",
            "type": "Microsoft.Common.TextBox",
            "label": "Number of compute nodes",
            "toolTip": "The number of compute nodes to be created",
            "defaultValue": "10",
            "constraints": {
              "required": true,
              "regex": "^[1-9][0-9]{0,2}$",
              "validationMessage": "Must be an integer between 1 and 999."
            }
          },
          {
            "name": "vmSize",
            "type": "Microsoft.Compute.SizeSelector",
            "label": "VM Size",
            "toolTip": "VM size for the compute nodes. If you want to create data disks for the compute nodes, remember the maximum number of data disks (defined by column 'DATA DISKS') supported for the VM size.",
            "recommendedSizes": [
              "Standard_D8s_v3",
              "Standard_DS4_v2",
              "Standard_F8s",
              "Standard_D4s_v3",
              "Standard_DS3_v2",
              "Standard_H16r",
              "Standard_H8",
              "Standard_H16",
              "Standard_DS4"
            ],
            "constraints": {
              "excludedSizes": [
                "Basic_A0",
                "Basic_A1",
                "Basic_A2",
                "Basic_A3",
                "Basic_A4",
                "Standard_A0",
                "Standard_A1"
              ]
            },
            "osPlatform": "Windows",
            "count": "[steps('computeNodeConfig').nodeNumber]"
          },
          {
            "name": "osDiskType1",
            "type": "Microsoft.Common.DropDown",
            "label": "OS disk type",
            "defaultValue": "Premium SSD",
            "toolTip": "Premium SSD disks offer high-performance, low-latency disk support for I/O-intensive applications and production workloads. To use Premium SSD disks, you must choose VM Size with premium storage support. Standard SSD Disks are a cost effective storage option optimized for workloads that need consistent performance at lower IOPS levels. Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Standard HDD",
                  "value": "Standard_LRS"
                },
                {
                  "label": "Standard SSD",
                  "value": "StandardSSD_LRS"
                },
                {
                  "label": "Premium SSD",
                  "value": "Premium_LRS"
                }
              ]
            },
            "visible": "[contains(toLower(replace(coalesce(steps('computeNodeConfig').vmSize, ''), 'Standard_', '')), 's')]"
          },
          {
            "name": "osDiskType2",
            "type": "Microsoft.Common.DropDown",
            "label": "OS disk type",
            "defaultValue": "Standard SSD",
            "toolTip": "Standard SSD Disks are a cost effective storage option optimized for workloads that need consistent performance at lower IOPS levels. Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Standard HDD",
                  "value": "Standard_LRS"
                },
                {
                  "label": "Standard SSD",
                  "value": "StandardSSD_LRS"
                }
              ]
            },
            "visible": "[not(contains(toLower(replace(coalesce(steps('computeNodeConfig').vmSize, ''), 'Standard_', '')), 's'))]"
          },
          {
            "name": "createDataDisks",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Create Data Disk(s)",
            "defaultValue": "No",
            "toolTip": "Specify whether you want to create data disk(s) for the compute nodes. Note the data disk(s) will not be initialized, you can initialize them by your own way.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": true
                },
                {
                  "label": "No",
                  "value": false
                }
              ]
            }
          },
          {
            "name": "dataDisks",
            "type": "Microsoft.Common.Section",
            "label": "Data Disk Settings",
            "elements": [
              {
                "name": "diskSize",
                "type": "Microsoft.Common.DropDown",
                "label": "Size of each data disk",
                "defaultValue": "128 GB",
                "toolTip": "The size for each data disk attached to compute nodes.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "32 GB",
                      "value": 32
                    },
                    {
                      "label": "64 GB",
                      "value": 64
                    },
                    {
                      "label": "128 GB",
                      "value": 128
                    },
                    {
                      "label": "256 GB",
                      "value": 256
                    },
                    {
                      "label": "512 GB",
                      "value": 512
                    },
                    {
                      "label": "1 TB",
                      "value": 1024
                    },
                    {
                      "label": "2 TB",
                      "value": 2048
                    },
                    {
                      "label": "4 TB",
                      "value": 4096
                    }
                  ]
                }
              },
              {
                "name": "diskCount",
                "type": "Microsoft.Common.DropDown",
                "label": "Number of data disks for each node",
                "defaultValue": "1",
                "toolTip": "The number of data disks attached to each compute node. Do not specify a number which exceeds the maximum data disk number of the compute node VM size. <br/>You can check the value of column 'DATA DISKS' of your selected compute node VM size or refer to <a href='https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes' target='_blank'>Azure VM sizes</a>",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "1",
                      "value": 1
                    },
                    {
                      "label": "2",
                      "value": 2
                    },
                    {
                      "label": "4",
                      "value": 4
                    },
                    {
                      "label": "8",
                      "value": 8
                    },
                    {
                      "label": "16",
                      "value": 16
                    }
                  ]
                }
              },
              {
                "name": "diskType1",
                "type": "Microsoft.Common.DropDown",
                "label": "Data disk type",
                "defaultValue": "Standard HDD",
                "toolTip": "Premium SSD disks offer high-performance, low-latency disk support for I/O-intensive applications and production workloads. To use Premium SSD disks, you must choose VM Size with premium storage support. Standard SSD Disks are a cost effective storage option optimized for workloads that need consistent performance at lower IOPS levels. Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard HDD",
                      "value": "Standard_LRS"
                    },
                    {
                      "label": "Standard SSD",
                      "value": "StandardSSD_LRS"
                    },
                    {
                      "label": "Premium SSD",
                      "value": "Premium_LRS"
                    }
                  ]
                },
                "visible": "[contains(toLower(replace(coalesce(steps('computeNodeConfig').vmSize, ''), 'Standard_', '')), 's')]"
              },
              {
                "name": "diskType2",
                "type": "Microsoft.Common.DropDown",
                "label": "Data disk type",
                "defaultValue": "Standard HDD",
                "toolTip": "Standard SSD Disks are a cost effective storage option optimized for workloads that need consistent performance at lower IOPS levels. Use Standard HDD disks for Dev/Test scenarios and less critical workloads at lowest cost.",
                "constraints": {
                  "allowedValues": [
                    {
                      "label": "Standard HDD",
                      "value": "Standard_LRS"
                    },
                    {
                      "label": "Standard SSD",
                      "value": "StandardSSD_LRS"
                    }
                  ]
                },
                "visible": "[not(contains(toLower(replace(coalesce(steps('computeNodeConfig').vmSize, ''), 'Standard_', '')), 's'))]"
              }
            ],
            "visible": "[steps('computeNodeConfig').createDataDisks]"
          },
          {
            "name": "enableAccelNet",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Accelerated networking",
            "defaultValue": "Off",
            "toolTip": "<a href='https://docs.microsoft.com/en-us/azure/virtual-network/create-vm-accelerated-networking-powershell' target='_blank'>Accelerated networking</a> can greatly improve cluster networking performance with lower latency and higher throughput. It is supported only on some VM sizes and operating systems. Turn it on only when the VM image and VM sizes you selected are all compatible.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "On",
                  "value": true
                },
                {
                  "label": "Off",
                  "value": false
                }
              ]
            },
            "visible": "[contains(';D4s_v3;D8s_v3;D16s_v3;D32s_v3;D64s_v3;D4_v3;D8_v3;D16_v3;D32_v3;D64_v3;D2_v2;D3_v2;D4_v2;D5_v2;D11_v2;D12_v2;D13_v2;D14_v2;D15_v2;DS2_v2;DS3_v2;DS4_v2;DS5_v2;DS11_v2;DS12_v2;DS13_v2;DS14_v2;DS15_v2;F2;F4;F8;F16;F2;F4;F8;F16;F2s;F4s;F8s;F16s;F4s_v2;F8s_v2;F16s_v2;F32s_v2;F64s_v2;F72s_v2;E4_v3;E8_v3;E16_v3;E20_v3;E32_v3;E64_v3;E64i_v3;E4s_v3;E8s_v3;E16s_v3;E20s_v3;E32s_v3;E64s_v3;E64is_v3;M8ms;M16ms;M32ts;M32ls;M32ms;M64s;M64ls;M64ms;M128s;M128ms', replace(coalesce(steps('computeNodeConfig').vmSize, 'None'), 'Standard_', ';'))]"
          },
          {
            "name": "useVmss",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Use VM scale set (Experimental)",
            "defaultValue": "No",
            "toolTip": "It is an experimental feature to create the compute nodes as VM scale set. Some HPC features (for example 'Auto grow shrink') are not supported for VM scale set",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": true
                },
                {
                  "label": "No",
                  "value": false
                }
              ]
            }
          },
          {
            "name": "vmPriority",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Use Spot instance (Experimental)",
            "defaultValue": "No",
            "toolTip": "It is an experimental feature to use <a href='http://go.microsoft.com/fwlink/?LinkId=2104270' target='_blank'>Azure Spot instance</a> to create the compute nodes. With this option, the Azure VMs can be evicted at any point in time when Azure needs the capacity back, in that case, the HPC compute nodes will be shown unreachable in HPC cluster manager.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": "Spot"
                },
                {
                  "label": "No",
                  "value": "Regular"
                }
              ]
            }
          },
          {
            "name": "runCustomScript",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Run custom script",
            "defaultValue": "No",
            "toolTip": "Specify whether you want to run custom script on the compute nodes",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": true
                },
                {
                  "label": "No",
                  "value": false
                }
              ]
            }
          },
          {
            "name": "customScript",
            "type": "Microsoft.Common.Section",
            "label": "Custom Script Settings",
            "elements": [
              {
                "name": "scriptFileUrls",
                "type": "Microsoft.Common.FileUpload",
                "label": "Upload script file(s)",
                "toolTip": "Upload the custom script files to run on the compute nodes, the script files will be stored in a Microsoft provided temporary location and get purged after 24 hours.",
                "constraints": {
                  "required": false,
                  "accept": ".ps1"
                },
                "options": {
                  "multiple": true,
                  "uploadMode": "url",
                  "openMode": "binary"
                },
                "visible": true
              },
              {
                "name": "scriptCommandLine",
                "type": "Microsoft.Common.TextBox",
                "label": "Command line to run",
                "toolTip": "Specify the command line to run custom script on the compute node as Local System account. <br/>You can directly run the uploaded script file(s) in the command line, for example: <br/>&nbsp;&nbsp;&nbsp;&nbsp;cncustomscript.ps1 -Arg1 arg1 -Arg2 arg2<br/>Or refer to <a href='https://docs.microsoft.com/en-us/powershell/scripting/components/console/powershell.exe-command-line-help' target='_blank'>PowerShell.exe command line help</a>, for example:<br/>&nbsp;&nbsp;&nbsp;&nbsp;1. PowerShell.exe -Command \"Start-Service -Name eventlog\"<br/>&nbsp;&nbsp;&nbsp;&nbsp;2. PowerShell.exe -EncodedCommand U3RhcnQtU2VydmljZSAtTmFtZSBldmVudGxvZw==<br/>&nbsp;&nbsp;&nbsp;&nbsp;3. PowerShell.exe -ExecutionPolicy Unrestricted -File cncustomscript.ps1 -Arg1 arg1 -Arg2 arg2",
                "defaultValue": "",
                "constraints": {
                  "required": true,
                  "regex": "^\\s*([Pp]ower[Ss]hell(\\.exe)?(\\s+([-/]\\S+)?)*[-/](([Ee]coded)?[Cc]ommand|[Ff]ile)(\\s+\\S+)+|(\\S+\\.[Pp][Ss]1)(\\s+\\S+)*)\\s*$",
                  "validationMessage": "Invalid command line, run a PowerShell script file or <a href='https://docs.microsoft.com/en-us/powershell/scripting/components/console/powershell.exe-command-line-help' target='_blank'>PowerShell.exe command</a>, Examples as below: <br/>1. cncustomscript.ps1 -Arg1 arg1 -Arg2 arg2<br/>2. PowerShell.exe -Command \"Start-Service -Name eventlog\"<br/>3. PowerShell.exe -EncodedCommand U3RhcnQtU2VydmljZSAtTmFtZSBldmVudGxvZw==<br/>4. PowerShell.exe -ExecutionPolicy Unrestricted -File cncustomscript.ps1 -Arg1 arg1 -Arg2 arg2"
                }
              }
            ],
            "visible": "[steps('computeNodeConfig').runCustomScript]"
          }
        ]
      },
      {
        "name": "infrastructureConfig",
        "label": "Infrastructure settings",
        "subLabel": {
          "preValidation": "Configure the infrastructure settings",
          "postValidation": "Done"
        },
        "bladeTitle": "Infrastructure settings",
        "elements": [
          {
            "name": "existingVNetText",
            "type": "Microsoft.Common.TextBlock",
            "options": {
              "text": "An Active Directory Domain is required for HPC user and computer authentication. You can either select an existing virtual network in which an AD domain was already created, or create a new virtual network so that a new AD domain will be created by promoting the head node as domain controller."
            }
          },
          {
            "name": "virtualNetwork",
            "type": "Microsoft.Network.VirtualNetworkCombo",
            "label": {
              "virtualNetwork": "Virtual network",
              "subnets": "Subnets"
            },
            "toolTip": {
              "virtualNetwork": "The virtual network in which the virtual machines will be deployed. If you choose an existing virtual network, make sure an AD domain already exists in it.",
              "subnets": "The subnet in which the virtual machines will be deployed"
            },
            "defaultValue": {
              "name": "[concat(basics('clusterName'), 'VNet')]",
              "addressPrefixSize": "/16"
            },
            "constraints": {
              "minAddressPrefixSize": "/24"
            },
            "options": {
              "hideExisting": false
            },
            "subnets": {
              "subnet1": {
                "label": "Subnet",
                "defaultValue": {
                  "name": "Subnet-1",
                  "addressPrefixSize": "/22"
                },
                "constraints": {
                  "minAddressPrefixSize": "/24",
                  "minAddressCount": "[max(50, add(1, steps('computeNodeConfig').nodeNumber))]",
                  "requireContiguousAddresses": false
                }
              }
            },
            "visible": true
          },
          {
            "name": "existingDomainName",
            "type": "Microsoft.Common.TextBox",
            "label": "Existing AD domain name",
            "toolTip": "The fully qualified domain name (FQDN) for the AD domain in which the virtual machines will join, for example, 'contoso.local'. Make sure the AD domain already exists in the select virtual network.",
            "constraints": {
              "required": true,
              "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
              "validationMessage": "Must be a valid fully-qualified domain name."
            },
            "visible": "[equals(coalesce(steps('infrastructureConfig').virtualNetwork.newOrExisting, ''), 'existing')]"
          },
          {
            "name": "newDomainName",
            "type": "Microsoft.Common.TextBox",
            "label": "New AD domain name",
            "toolTip": "The fully qualified domain name (FQDN) for the new AD domain in which the virtual machines will join, for example, 'hpc.local'. ",
            "defaultValue": "hpc.local",
            "constraints": {
              "required": true,
              "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
              "validationMessage": "Must be a valid fully-qualified domain name."
            },
            "visible": "[equals(coalesce(steps('infrastructureConfig').virtualNetwork.newOrExisting, ''), 'new')]"
          },
          {
            "name": "adminUsername",
            "type": "Microsoft.Compute.UserNameTextBox",
            "label": "Username",
            "toolTip": "The domain user name, also used as local administrator user name for the virtual machines.",
            "constraints": {
              "required": true
            },
            "osPlatform": "Windows"
          },
          {
            "name": "adminPassword",
            "type": "Microsoft.Compute.CredentialsCombo",
            "label": {
              "password": "Password",
              "confirmPassword": "Confirm password"
            },
            "toolTip": {
              "password": "The domain user password, also used as local administrator user password."
            },
            "osPlatform": "Windows",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "soaStorageAccount",
            "type": "Microsoft.Storage.StorageAccountSelector",
            "label": "Storage account for SOA",
            "toolTip": "The storage account for SOA common data and SOA session monitoring features",
            "defaultValue": {
              "name": "[concat(basics('clusterName'), string(rand(1, 99999999)))]",
              "type": "Standard_LRS"
            },
            "constraints": {
              "allowedTypes": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_ZRS"
              ]
            },
            "options": {
              "hideExisting": false
            },
            "visible": true
          }
        ]
      }
    ],
    "outputs": {
      "clusterName": "[basics('clusterName')]",
      "location": "[location()]",
      "virtualNetworkResourceGroupName": "[steps('infrastructureConfig').virtualNetwork.resourceGroup]",
      "virtualNetworkName": "[steps('infrastructureConfig').virtualNetwork.name]",
      "virtualNetworkAddressPrefixes": "[steps('infrastructureConfig').virtualNetwork.addressPrefixes]",
      "newOrExistingDomainForest": "[steps('infrastructureConfig').virtualNetwork.newOrExisting]",
      "subnetName": "[steps('infrastructureConfig').virtualNetwork.subnets.subnet1.name]",
      "subnetAddressPrefix": "[steps('infrastructureConfig').virtualNetwork.subnets.subnet1.addressPrefix]",
      "subnetStartAddress": "[steps('infrastructureConfig').virtualNetwork.subnets.subnet1.startAddress]",
      "domainName": "[coalesce(steps('infrastructureConfig').newDomainName, steps('infrastructureConfig').existingDomainName)]",
      "adminUsername": "[steps('infrastructureConfig').adminUsername]",
      "adminPassword": "[steps('infrastructureConfig').adminPassword.password]",
      "soaStorageAccountCreateOption": "[steps('infrastructureConfig').soaStorageAccount.newOrExisting]",
      "soaStorageAccountResourceGroupName": "[steps('infrastructureConfig').soaStorageAccount.resourceGroup]",
      "soaStorageAccountName": "[steps('infrastructureConfig').soaStorageAccount.name]",
      "soaStorageAccountType": "[steps('infrastructureConfig').soaStorageAccount.type]",
      "publicIPName": "[steps('headNodeConfig').publicIP.name]",
      "publicIPResourceGroupName": "[steps('headNodeConfig').publicIP.resourceGroup]",
      "publicIPCreateOption": "[steps('headNodeConfig').publicIP.newOrExistingOrNone]",
      "publicIPDNSNameLabel": "[steps('headNodeConfig').publicIP.domainNameLabel]",
      "publicIPSku": "[steps('headNodeConfig').publicIP.sku]",
      "publicIPAllocationMethod": "[steps('headNodeConfig').publicIP.publicIPAllocationMethod]",
      "headNodeVMSize": "[steps('headNodeConfig').vmSize]",
      "headNodeOsDiskType": "[coalesce(steps('headNodeConfig').osDiskType1, steps('headNodeConfig').osDiskType2)]",
      "headNodeDataDiskSize": "[steps('headNodeConfig').dataDisks.diskSize]",
      "headNodeDataDiskType": "[coalesce(steps('headNodeConfig').dataDisks.diskType1, steps('headNodeConfig').dataDisks.diskType2)]",
      "headNodeDataDiskCount": "[steps('headNodeConfig').dataDisks.diskCount]",
      "headNodeEnableAcceleratedNetworking": "[steps('headNodeConfig').enableAccelNet]",
      "headNodePostConfigScriptFileUrls": "[steps('headNodeConfig').customScript.scriptFileUrls]",
      "headNodePostConfigScriptCommand": "[steps('headNodeConfig').customScript.scriptCommandLine]",
      "computeNodeImageOsPlatform": "Windows",
      "computeNodeImageRef": "[basics('workLoadType').computeNodeImage]",
      "computeNodeNamePrefix": "[steps('computeNodeConfig').namePrefix]",
      "computeNodeNumber": "[int(steps('computeNodeConfig').nodeNumber)]",
      "computeNodeVMSize": "[steps('computeNodeConfig').vmSize]",
      "computeNodeOsDiskType": "[coalesce(steps('computeNodeConfig').osDiskType1, steps('computeNodeConfig').osDiskType2)]",
      "computeNodeDataDiskSize": "[steps('computeNodeConfig').dataDisks.diskSize]",
      "computeNodeDataDiskType": "[coalesce(steps('computeNodeConfig').dataDisks.diskType1, steps('computeNodeConfig').dataDisks.diskType2)]",
      "computeNodeDataDiskCount": "[steps('computeNodeConfig').dataDisks.diskCount]",
      "computeNodeEnableAcceleratedNetworking": "[steps('computeNodeConfig').enableAccelNet]",
      "useVmssForComputeNodes": "[steps('computeNodeConfig').useVmss]",
      "computeNodeVmPriority": "[steps('computeNodeConfig').vmPriority]",      
      "computeNodeCustomScriptFileUrls": "[steps('computeNodeConfig').customScript.scriptFileUrls]",
      "computeNodeCustomScriptCommand": "[steps('computeNodeConfig').customScript.scriptCommandLine]"
    }
  }
}
